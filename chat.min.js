class Chat{constructor({position:e="bottom-right",appID:t=""}={}){this.position=this.getPosition(e),this.appID=t,this.user={},this.company="",this.open=!1,this.loaded=!1,this.logo="",this.firstMessage="",this.createStyles(),this.initialise(),this.ticket={},this.action=-1}getPosition(e){const[t,s]=e.split("-");return{[t]:"30px",[s]:"30px"}}createStyles(){const e=document.createElement("style");document.head.appendChild(e),e.innerHTML="\n            .icon{\n                cursor: pointer;\n                width: 50%;\n                position: absolute;\n                left: 50%;\n                margin-left: -12.5px;\n                top: 50%;\n                margin-top: -12.5px;\n                transition: transform .3s ease;\n            }\n            \n            .hidden{\n                transform: scale(0);\n            }\n\n            .button-container {\n                background-color: #000;\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n            }\n            \n            .message-container{\n                box-shadow: 0 0 18px 8px rgba(0,0,0,0.1);\n                width: 400px;\n                right: -25px;\n                max-height: 600px;\n                overflow: auto;\n                bottom: 75px;\n                position: absolute;\n                transition:  max-height .2s ease;\n                font-family: Helvetica, Arial, sans-serif;\n                z-index: 999;\n                background-color: white;\n            }\n            \n            .message-container.hidden {\n                max-height: 0px;\n            }\n            \n            .message-container header{\n                background-color: #000;\n                display: flex;\n                flex-direction: column;\n                justify-content: flex-start\n            }\n            \n            .message-container h2{\n                margin: 0;\n                font-size: 14px;\n                padding: 20px 20px 0px 20px;\n                color: #fff;\n                background-color: #0f0f0f;\n            }\n            \n            .message-container p{\n                margin: 0;\n                font-size: 12px;\n                font-weight: 300;\n                padding: 0px 20px 20px;\n                color: #ddd;\n                background-color: #0f0f0f;\n            }\n            \n            .AIBOT{\n                min-height: 400px;\n                max-height: 400px;\n                overflow: auto;\n                padding: 20px;\n                display: flex;\n                flex-direction: column;\n                transition: all .5 ease-in;\n                scroll-behavior: smooth;\n            }\n            \n            .messageAI{\n                 margin-bottom: 5px;\n                 margin-top: 5px;\n                 max-width: 50%;\n                 left: 10px;\n                 background-color: #000;\n                 padding: 20px;\n                 border-radius: 10px;\n                 color: white;\n                 font-size: 14px;\n                 opacity: 0;\n                 transition: all 0.5s;\n            }\n            \n            .messageUser{\n                max-width: 50%;\n                margin-bottom: 5px;\n                margin-top: 5px;\n                align-self: flex-end;\n                right: 10px;\n                background-color: #efefef;\n                padding: 20px;\n                border-radius: 20px;\n                font-size: 14px;\n                cursor: pointer;\n                opacity: 0;\n                transition: all 0.5s;\n                \n            }\n            .messageUser2{\n                max-width: 50%;\n                margin-bottom: 5px;\n                margin-top: 5px;\n                border: 1px solid grey;\n                align-self: flex-end;\n                right: 10px;\n                background-color: #efefef;\n                padding: 20px;\n                border-radius: 20px;\n                font-size: 14px;\n                cursor: pointer;\n                opacity: 0;\n                transition: all 0.5s;\n            }\n            \n            .sendMenu{\n                display: flex;\n                flex-direction: row;\n                align-items: center;\n                max-height: 50px;\n                padding: 5px \n            }\n            \n            input {\n                padding: 10px;\n                width: 80%;\n                border: none;\n                border-bottom: 2px solid #ddd;\n            }\n            \n            .icon2 {\n                width: 30px;\n                height: 30px;\n                padding-left: 5px;\n                cursor: pointer;\n                align-self: center;\n            }\n            \n\n            \n            "}async load(e){const t=await fetch("https://geolocation-db.com/json/",{method:"GET"}),s=await t.json(),i=await fetch(`https://hubpluginserver.azurewebsites.net/sessions/createsession?id=${e}&user=${s.IPv4}`,{method:"POST"}),n=await i.json();null!=n.error&&this.messageViewer.appendChild("Your subscription is has expired!"),this.loaded=!0,this.company=n.company,this.logo=n.logo,this.user={...n.user}}initializeMessageButton(){const e=document.createElement("div");e.style.position="fixed",Object.keys(this.position).forEach(t=>e.style[t]=this.position[t]),document.body.appendChild(e);const t=document.createElement("div");t.classList.add("button-container");const s=document.createElement("img");s.src="https://www.nortb.com/icons_chatbot/chattBubbleWhite.svg",s.classList.add("icon"),this.chatIcon=s;const i=document.createElement("img");i.src="https://www.nortb.com/icons_chatbot/OpenWhite.svg",i.classList.add("icon","hidden"),this.closeIcon=i,this.container=e,e.appendChild(t),t.appendChild(this.chatIcon),t.appendChild(this.closeIcon),t.addEventListener("click",this.toggleOpen.bind(this))}initialise(){this.load(this.appID),this.initializeMessageButton()}toggleOpen(){this.open=!this.open,this.open?(this.chatIcon.classList.add("hidden"),this.closeIcon.classList.remove("hidden"),this.showMessageContainer()):(this.chatIcon.classList.remove("hidden"),this.closeIcon.classList.add("hidden"),this.container.removeChild(this.messageContainer))}submitAction(e){if(1===this.action){var t;if(!this.ticket.problem)""!==(t=document.querySelector("#email").value).trim()&&(this.ticket={...this.ticket,problem:t},this.messageViwer.appendChild(this.messageUser(t)),this.updateScroll(),document.querySelector("#email").value="");if(!this.ticket.name&&!this.user.name&&""===document.querySelector("#email").value)return this.messageViwer.appendChild(this.messageAI("Great! Can you tell us your name?")),this.updateScroll();if(!this.ticket.name&&!this.user.name)""!==(t=document.querySelector("#email").value).trim()&&(this.ticket={...this.ticket,name:t},this.messageViwer.appendChild(this.messageUser(t)),this.updateScroll(),document.querySelector("#email").value="");if(!this.ticket.email&&!this.user.email&&""===document.querySelector("#email").value)return this.messageViwer.appendChild(this.messageAI("Great! Can you tell us your email?")),this.updateScroll();if(!this.ticket.email&&!this.user.email)""!==(t=document.querySelector("#email").value).trim()&&(this.ticket={...this.ticket,email:t},this.messageViwer.appendChild(this.messageUser(t))),this.updateScroll(),document.querySelector("#email").value="";if(!this.ticket.company&&""===document.querySelector("#email").value)return this.messageViwer.appendChild(this.messageAI("Awesome! To which company do you work?")),this.updateScroll();if(!this.ticket.company)""!==(t=document.querySelector("#email").value).trim()&&(this.ticket={...this.ticket,company:t},this.messageViwer.appendChild(this.messageUser(t))),this.updateScroll(),document.querySelector("#email").value="";return this.createTicket(),this.messageViwer.appendChild(this.messageAI("Perfect! We will open now a ticket and one of our assistants will come back to you asap!")),this.updateScroll(),this.sendMenu.classList.add("hidden")}}async createTicket(){console.log({company:this.company,user:this.user._id,ticket:{...this.ticket,name:this.ticket.name?this.ticket.name:this.user.name,email:this.ticket.email?this.ticket.email:this.user.email}});const e=await fetch("https://hubpluginserver.azurewebsites.net/sessions/createticket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({company:this.company,user:this.user._id,ticket:{...this.ticket,name:this.ticket.name?this.ticket.name:this.user.name,email:this.ticket.email?this.ticket.email:this.user.email}})});console.log(await e.json())}showMessageContainer(){this.messageContainer=document.createElement("div"),this.messageContainer.style.borderRadius="20px",this.messageContainer.classList.add("message-container");const e=document.createElement("div");e.classList.add("header"),e.style.borderRadius="20px",e.style.backgroundColor="black";const t=document.createElement("h2");t.textContent="Hi there!",t.style.fontSize="32px";const s=document.createElement("p");s.textContent="We are not here yet!";const i=document.createElement("img");i.src=this.logo,i.style.width="50px",i.style.height="50px",i.style.marginLeft="15px",i.style.marginTop="15px",e.appendChild(i),e.appendChild(t),e.appendChild(s);const n=document.createElement("div");n.id="messageViewer",n.style.height="400px",n.style.overflowY="auto",n.style.padding="15px",n.style.display="flex",n.style.flexDirection="column",this.messageViwer=n,this.loadFirstMessage();const a=document.createElement("div");a.classList.add("sendMenu"),a.classList.add("hidden");const o=document.createElement("input");o.style.width="100%",o.required=!0,o.id="email",o.type="text",o.placeholder="message",o.addEventListener("keyup",e=>{"Enter"===e.key&&(e.preventDefault(),this.submitAction())}),a.appendChild(o),this.sendMenu=a,this.messageContainer.appendChild(e),this.messageContainer.appendChild(n),this.messageContainer.appendChild(a),this.container.appendChild(this.messageContainer)}async loadFirstMessage(){this.addLoadingMessage();const e=await fetch(`https://hubpluginserver.azurewebsites.net/steps/firststep?id=${this.appID}`,{method:"GET"});this.removeLoadinMessage();const t=await e.json();this.messageViwer.appendChild(this.messageAI(t.message));for(let e=0;e<t.childs.length;e++)this.messageViwer.appendChild(this.messageUser2(t.childs[e].message,t.childs[e]._id)),this.updateScroll()}messageUser(e){const t=document.createElement("span");return t.classList.add("messageUser"),t.innerText=e,t.style.opacity=1,t}messageUser2(e,t){const s=document.createElement("div");return s.classList.add("messageUser2"),s.innerText=e,s.style.opacity=1,s.addEventListener("click",()=>this.fetchNextStep(t)),s}messageAI(e,t){const s=document.createElement("div");return s.id=t,s.classList.add("messageAI"),s.innerText=e,s.style.opacity=1,s}addLoadingMessage(){const e=document.createElement("div");e.id="loading",e.classList.add("messageAI"),e.innerText="Loading…",e.style.opacity=1,this.loadingMessage=e,this.messageViwer.appendChild(e).scrollIntoView({behavior:"smooth"})}removeLoadinMessage(){this.messageViwer.removeChild(this.loadingMessage)}async fetchNextStep(e){this.addLoadingMessage();const t=await fetch(`https://hubpluginserver.azurewebsites.net/steps/fetchstep?id=${e}`,{method:"GET"}),s=await t.json();if(this.removeLoadinMessage(),this.messageViwer.appendChild(this.messageAI(s.message)).scrollIntoView({behavior:"smooth"}),await this.delay(1e3),-1===s.action&&this.toggleOpen(),0===s.action)for(let e=0;e<s.childs.length;e++)this.messageViwer.appendChild(this.messageUser2(s.childs[e].message,s.childs[e]._id)),this.updateScroll();1===s.action&&(this.action=s.action,this.sendMenu.classList.remove("hidden"))}delay(e){return new Promise(t=>setTimeout(t,e))}updateScroll(){var e=this.messageViwer;e.scrollTop=e.scrollHeight}}let script=document.getElementById("nortbHUB"),appID=script.getAttribute("appID");export const chat=new Chat({position:"bottom-right",appID:appID});