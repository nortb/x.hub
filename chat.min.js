class Chat{constructor({appID:e=""}={}){this.appID=e,this.user="",this.sessionId="",this.company="",this.open=!1,this.loaded=!1,this.logo="",this.firstMessage="",this.initialise(),this.load(this.appID),this.color="",this.color2="",this.createStyles(),this.ticket={problem:"",name:"",email:""},this.header="",this.sublime="",this.activeTag="",this.action=-99,this.nextStep=""}createStyles(){const e=document.createElement("style");document.head.appendChild(e),e.innerHTML="\n            .containeri{\n                bottom: 30px;\n                right: 30px;\n                position: fixed;\n            }\n            .icon{\n                cursor: pointer;\n                width: 50%;\n                position: absolute;\n                left: 50%;\n                margin-left: -12.5px;\n                top: 50%;\n                margin-top: -12.5px;\n                transition: transform .3s ease;\n            }\n            \n            .hidden{\n                transform: scale(0);\n            }\n\n            .button-container {\n                background-color: #000;\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n            }\n            \n            .message-container{\n                box-shadow: 0 0 18px 8px rgba(0,0,0,0.1);\n                width: 400px;\n                right: -25px;\n                max-height: 600px;\n                \n                bottom: 75px;\n                position: absolute;\n                transition:  max-height .2s ease;\n                font-family: Helvetica, Arial, sans-serif;\n                z-index: 999;\n                background-color: white;\n            }\n            \n            .message-container.hidden {\n                max-height: 0px;\n            }\n            \n            .message-container header{\n                display: flex;\n                flex-direction: column;\n                justify-content: flex-start\n            }\n            \n            .message-container h2{\n                margin: 0;\n                font-size: 14px;\n                padding: 20px 20px 0px 20px;\n                color: #fff;\n            }\n            \n            .message-container p{\n                margin: 0;\n                font-size: 12px;\n                font-weight: 300;\n                padding: 0px 20px 20px;\n                color: #ddd;\n            }\n            \n            .AIBOT{\n                min-height: 400px;\n                max-height: 400px;\n                overflow: auto;\n                padding: 20px;\n                display: flex;\n                flex-direction: column;\n                transition: all .5 ease-in;\n                scroll-behavior: smooth;\n            }\n            \n            .messageAI{\n                 margin-bottom: 5px;\n                 margin-top: 5px;\n                 max-width: 50%;\n                 left: 10px;\n                 color: #fff\n                 padding: 20px;\n                 border-radius: 10px;\n                 color: white;\n                 font-size: 14px;\n                 opacity: 0;\n                 transition: all 0.5s;\n            }\n            \n            .messageUser{\n                max-width: 50%;\n                margin-bottom: 5px;\n                margin-top: 5px;\n                align-self: flex-end;\n                right: 10px;\n                background-color: #efefef;\n                padding: 20px;\n                \n                font-size: 14px;\n                cursor: pointer;\n                opacity: 0;\n                transition: all 0.5s;\n                \n            }\n            .messageUser2{\n                max-width: 50%;\n                margin-bottom: 5px;\n                margin-top: 5px;\n                border: 1px solid grey;\n                align-self: flex-end;\n                right: 10px;\n                background-color: #efefef;\n                padding: 20px;\n                border-radius: 20px;\n                font-size: 14px;\n                cursor: pointer;\n                opacity: 0;\n                transition: all 0.5s;\n            }\n            \n            .sendMenu{\n                display: flex;\n                flex-direction: row;\n                align-items: center;\n                max-height: 50px;\n                padding: 5px;\n                fontSize: 14px;\n            }\n            \n            input {\n                padding: 10px;\n                width: 80%;\n                border: none;\n                border-bottom: 2px solid #ddd;\n            }\n            \n            .icon2 {\n                width: 30px;\n                height: 30px;\n                padding-left: 5px;\n                cursor: pointer;\n                align-self: center;\n            }\n            "}addLoadingMessage(){const e=document.createElement("div");e.id="loading",e.classList.add("messageAI"),e.innerText="Loadingâ€¦",e.style.opacity=1,e.style.padding="20px",this.loadingMessage=e,this.messageViwer.appendChild(e).scrollIntoView({behavior:"smooth"})}removeLoadinMessage(){this.messageViwer.removeChild(this.loadingMessage)}initialise(){const e=document.createElement("div");e.classList.add("containeri"),document.body.appendChild(e);const t=document.createElement("div");t.classList.add("button-container"),t.style.backgroundColor=this.color;const s=document.createElement("img");s.src="https://www.nortb.com/img/chat1.svg",s.classList.add("icon"),this.chatIcon=s;const i=document.createElement("img");i.src="https://www.nortb.com/img/chat2.svg",i.classList.add("icon","hidden"),this.closeIcon=i,this.container=e,this.buttonContainer=t,e.appendChild(t),t.appendChild(this.chatIcon),t.appendChild(this.closeIcon),t.addEventListener("click",this.toggleOpen.bind(this))}async load(e){const t=await fetch(`https://hubpluginserver.azurewebsites.net/companies/company?id=${e}`,{method:"GET"}),s=await t.json();null!=s.error?(this.messageViewer.appendChild("Your subscription has expired!"),this.loaded=!1):(this.color=s.color,this.buttonContainer.style.backgroundColor=s.color,this.company=s,this.company.id=e,this.logo=s.logo,this.ticket={enterprise:s.type>=3||0===s.type?1:0},this.header=s.header,this.sublime=s.sublime,this.loaded=!0)}async createSession(){const e=await fetch("https://geolocation-db.com/json/",{method:"GET"}),t=await e.json(),s=await fetch(`https://hubpluginserver.azurewebsites.net/sessions/createsession?id=${appID}&user=${t.IPv4}`,{method:"POST"}),i=await s.json();this.userId=i.user,this.sessionId=i.session}toggleOpen(){this.loaded&&(this.open=!this.open,this.open?(""===this.sessionId&&this.createSession(),this.chatIcon.classList.add("hidden"),this.closeIcon.classList.remove("hidden"),this.showMessageContainer()):(this.chatIcon.classList.remove("hidden"),this.messageContainer.classList.add("hidden"),this.closeIcon.classList.add("hidden")))}showMessageContainer(){this.messageContainer=document.createElement("div"),this.messageContainer.style.borderRadius="20px",this.messageContainer.classList.add("message-container");const e=document.createElement("div");e.classList.add("header"),e.style.borderRadius="20px",e.style.backgroundColor=this.color;const t=document.createElement("h2");t.textContent=this.header,t.style.color=this.color2,t.style.fontSize="32px";const s=document.createElement("p");s.textContent=this.sublime,s.style.color=this.color2;const i=document.createElement("img");i.src=this.logo,i.style.height="50px",i.style.marginLeft="15px",i.style.marginTop="15px",e.appendChild(i),e.appendChild(t),e.appendChild(s);const n=document.createElement("div");n.id="messageViewer",n.style.height="350px",n.style.overflowY="auto",n.style.padding="15px",n.style.display="flex",n.style.flexDirection="column",this.messageViwer=n;const a=document.createElement("div");a.classList.add("sendMenu"),a.classList.add("hidden");const o=document.createElement("input");o.style.outline="none",o.style.width="100%",o.style.fontSize="14px",o.required=!0,o.id="email",o.type="text",o.placeholder="message",o.addEventListener("keyup",e=>{"Enter"===e.key&&(e.preventDefault(),this.submitAction())}),this.loadFirstMessage(),a.appendChild(o),this.sendMenu=a,this.messageContainer.appendChild(e),this.messageContainer.appendChild(n),this.messageContainer.appendChild(a),this.container.appendChild(this.messageContainer)}messageUser(e){const t=document.createElement("span");return t.classList.add("messageUser"),t.innerText=e,t.style.opacity=1,t.style.borderRadius="10px",t}messageUser2(e,t){const s=document.createElement("div");return s.classList.add("messageUser2"),s.innerText=e,s.style.opacity=1,s.style.padding="20px",s.addEventListener("click",()=>this.fetchNextStep(t)),s}messageAI(e,t){const s=document.createElement("div");return s.style.backgroundColor=this.color,s.id=t,s.classList.add("messageAI"),s.innerText=e,s.style.opacity=1,s.style.padding="20px",s}updateScroll(){var e=this.messageViwer;e.scrollTop=e.scrollHeight}delay(e){return new Promise(t=>setTimeout(t,e))}async loadFirstMessage(){this.addLoadingMessage();const e=await fetch(`https://hubpluginserver.azurewebsites.net/steps/firststep?id=${this.appID}`,{method:"GET"}),t=await e.json();if(this.removeLoadinMessage(),this.messageViwer.appendChild(this.messageAI(t.message)),0===t.action){this.action=0;for(let e=0;e<t.childs.length;e++)this.messageViwer.appendChild(this.messageUser2(t.childs[e].message,t.childs[e])),this.updateScroll()}1===t.action&&(this.ticket[t.tag]="",this.activeTag=t.tag,this.nextStep=t.childs[0],this.action=1,this.updateScroll(),this.sendMenu.classList.remove("hidden"))}submitAction(){if(1===this.action){var e=document.querySelector("#email").value;""!==e.trim()&&(this.messageViwer.appendChild(this.messageUser(e)),this.ticket={...this.ticket,[this.activeTag]:e},this.fetchNextStep(this.nextStep),this.updateScroll(),document.querySelector("#email").value="")}}async fetchRepliers(e){const t=await fetch(`https://hubpluginserver.azurewebsites.net/steps/fetchstep?id=${e}`,{method:"GET"}),s=await t.json();if(console.log(s),0===s.action){this.action=0;for(let e=0;e<s.childs.length;e++)this.messageViwer.appendChild(this.messageUser2(s.childs[e].message,s.childs[e])),this.updateScroll()}1===s.action&&(this.action=0,this.ticket[s.tag]="",this.activeTag=s.tag,this.nextStep=s.childs[0],this.action=1,this.sendMenu.classList.remove("hidden"),this.updateScroll())}async fetchNextStep(e){this.addLoadingMessage();const t=await fetch(`https://hubpluginserver.azurewebsites.net/steps/fetchstep?id=${e._id}`,{method:"GET"}),s=await t.json();if(console.log(s),this.removeLoadinMessage(),0===s.action)for(let e=0;e<s.childs.length;e++)this.messageViwer.appendChild(this.messageAI(s.childs[e].message)),this.updateScroll(),this.fetchRepliers(s.childs[e]._id);if(1===s.action&&(this.messageViwer.appendChild(this.messageAI(s.message)),this.ticket[s.tag]="",this.activeTag=s.tag,this.nextStep=s.childs[0],this.action=1,this.sendMenu.classList.remove("hidden"),this.updateScroll()),2===s.action){this.updateScroll(),this.messageViwer.appendChild(this.messageAI(s.message)),""===this.ticket.company&&(this.ticket.company=this.company.name),this.ticket.companyid=this.company.id,this.ticket.user=this.userId,this.ticket.session=this.sessionId;const e=await fetch("https://hubpluginserver.azurewebsites.net/sessions/createticket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ticket:{...this.ticket}})});await e.json(),this.sendMenu.classList.add("hidden")}if(3===s.action){this.updateScroll(),this.messageViwer.appendChild(this.messageAI(s.message)),""===this.ticket.company&&(this.ticket.company=this.company.name),this.ticket.companyid=this.company.id,this.ticket.user=this.userId,this.ticket.session=this.sessionId;const e=await fetch("https://hubpluginserver.azurewebsites.net/sessions/createticket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ticket:{...this.ticket}})});await e.json(),this.sendMenu.classList.add("hidden")}}}let script=document.getElementById("nortbHUB"),appID=script.getAttribute("appID");export const chat=new Chat({appID:appID});
